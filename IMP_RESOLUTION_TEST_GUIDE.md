# 小惡魔結算效果測試指南

## 功能概述

小惡魔 (Imp, F002) 是一張帶有結算階段效果的卡片。本功能實作了完整的結算階段流程，包含呼吸發光效果和玩家確認對話框。

---

## 測試環境設置

### 單人遊戲模式
- 小惡魔會自動出現在初始手牌中
- Ifrit 會出現在市場中（方便測試其他效果）

### 多人遊戲模式
- 小惡魔正常出現在牌庫中
- 結算邏輯已整合到多人遊戲服務

---

## 完整測試流程（單人遊戲）

### 步驟 1：啟動遊戲
1. 開啟單人遊戲模式
2. **預期結果**：初始手牌中包含小惡魔卡片

### 步驟 2：選擇神器
1. 選擇任意神器
2. 點擊「確認神器」
3. **預期結果**：進入 ACTION 階段，手牌區顯示小惡魔

### 步驟 3：召喚小惡魔
1. 從手牌區拖曳小惡魔到場上（或點擊「召喚」按鈕）
2. **預期結果**：
   - ⚡ 閃電效果出現
   - 獲得 2 個 1 點石頭
   - 小惡魔出現在場上（PlayField 區域）
   - 卡片右下角顯示 ★ 金色星星標註（表示效果已實現）

### 步驟 4：結束行動階段
1. 點擊右側的「結束回合」按鈕
2. **預期結果**：
   - 進入 SCORE (結算) 階段
   - 小惡魔開始顯示**呼吸發光效果**（卡片輕微放大縮小 + 金色光暈）
   - 「結束回合」按鈕變成灰色（禁用狀態）
   - 按鈕下方顯示提示：「還有 1 張結算效果卡片待處理」

### 步驟 5：點擊發光的小惡魔
1. 點擊正在發光呼吸的小惡魔卡片
2. **預期結果**：
   - 彈出「結算效果」確認對話框
   - 對話框顯示小惡魔的圖片和名稱
   - 顯示問題：「是否要讓 小惡魔 回到手上？」
   - 提供兩個選項：
     - ❌ 「否，留在場上」（左側按鈕）
     - ✅ 「是，回到手上」（右側按鈕，琥珀色高亮）

### 步驟 6A：選擇「是，回到手上」
1. 點擊「是，回到手上」按鈕
2. **預期結果**：
   - 小惡魔從場上消失
   - 小惡魔回到手牌區
   - 呼吸發光效果消失
   - 「結束回合」按鈕恢復可用（變成綠色）
   - 提示訊息消失

### 步驟 6B：選擇「否，留在場上」
1. 點擊「否，留在場上」按鈕
2. **預期結果**：
   - 小惡魔保持在場上
   - 呼吸發光效果消失
   - 「結束回合」按鈕恢復可用（變成綠色）
   - 提示訊息消失

### 步驟 7：完成結算階段
1. 點擊「結束回合」按鈕
2. **預期結果**：
   - 進入下一回合的 DRAW 階段
   - 回合數 +1
   - 如果小惡魔回到手上，可以再次召喚測試

---

## 視覺效果檢查清單

### ✅ 呼吸發光效果
- [ ] 卡片邊框有金色脈衝光暈
- [ ] 卡片整體有輕微的縮放動畫（1.0 ↔ 1.03）
- [ ] 光暈強度隨呼吸變化（弱 ↔ 強）
- [ ] 動畫循環時間約 2 秒
- [ ] 懸停時放大並增強光暈

### ✅ 確認對話框
- [ ] 對話框置中顯示
- [ ] 顯示卡片圖片（140x210px）
- [ ] 顯示中英文卡片名稱
- [ ] 問題文字清晰易讀
- [ ] 兩個按鈕樣式區分明顯
- [ ] 背景有半透明遮罩

### ✅ 按鈕狀態
- [ ] 有待處理卡片時，按鈕灰色禁用
- [ ] 處理完成後，按鈕恢復綠色可用
- [ ] 提示訊息準確顯示待處理數量

---

## 多人遊戲測試流程

1. **建立房間**：創建多人遊戲房間
2. **加入玩家**：至少2位玩家加入
3. **開始遊戲**：選擇神器並開始
4. **召喚小惡魔**：任一玩家從手牌或市場召喚小惡魔
5. **結束回合**：該玩家點擊「結束回合」
6. **結算階段**：
   - 該玩家看到小惡魔呼吸發光
   - 其他玩家看到該玩家的小惡魔也在發光
   - 該玩家點擊小惡魔並選擇是否回手
7. **同步驗證**：所有玩家看到相同的結果

---

## 已實現的技術細節

### 類型定義 (types/game.ts)
- `SinglePlayerPhase.RESOLUTION` - 結算階段 enum
- `SinglePlayerActionType.PROCESS_RESOLUTION` - 處理結算 action
- `SinglePlayerActionType.SKIP_RESOLUTION` - 跳過結算 action
- `pendingResolutionCards` - 待處理的結算卡片列表
- `processedResolutionCards` - 已處理的結算卡片列表

### 遊戲引擎 (single-player-engine.ts v7.22.0)
- `pass()` - 檢測並進入結算階段
- `processResolutionCard()` - 處理結算效果
- `completeSettlement()` - 結算完成檢查
- 初始手牌強制包含小惡魔 (測試模式)

### UI 組件
- `Card.tsx` - 支援 `hasPendingResolution` prop
- `ResolutionConfirmModal.tsx` - 結算確認對話框
- `PlayersFieldArea.tsx` - 場上卡片發光邏輯
- `GameHeader.tsx` - 結束回合按鈕禁用邏輯

### CSS 動畫 (index.css)
- `animate-resolution-breathing` - 呼吸縮放效果
- `animate-resolution-glow` - 脈衝發光疊加層
- `.resolution-badge` - 結算標記樣式

### 實現狀態標記 (effect-implementation-status.ts v1.4.0)
- `EARN_STONES` - 已實現 ⭐
- `RECOVER_CARD` - 已實現 ⭐
- 小惡魔右下角顯示金色星星

---

## 常見問題排查

### Q: 小惡魔沒有出現在初始手牌
**A**: 檢查 `forceTestCardsInMarket` 參數是否為 `true` (預設值)

### Q: 呼吸效果沒有顯示
**A**: 檢查以下項目：
1. 是否進入了 SCORE (結算) 階段
2. `pendingResolutionCards` 是否包含小惡魔的 instanceId
3. 瀏覽器 console 是否有 CSS 動畫相關錯誤

### Q: 點擊小惡魔沒有反應
**A**: 檢查：
1. 是否在 SCORE 階段
2. 是否已經處理過這張卡（processedResolutionCards）
3. onClick handler 是否正確綁定

### Q: 「結束回合」按鈕無法點擊
**A**: 這是預期行為，必須處理完所有結算效果卡片後才能結束回合

---

## 版本資訊

- **遊戲引擎**: v7.22.0
- **效果狀態追蹤**: v1.4.0
- **完成日期**: 2026-01-03
- **實作者**: Claude Code
- **測試狀態**: ✅ 建置成功

---

## 後續擴展

如需添加更多結算效果卡片：

1. 在卡片定義中加入 `RECOVER_CARD` + `PERMANENT` 效果
2. 引擎會自動檢測並加入結算流程
3. 確認對話框可複用於所有結算卡片
4. 更新 `effect-implementation-status.ts` 標記效果為已實現

**注意**：目前的實現是針對「可選擇回手」的結算效果。如果需要強制執行或其他類型的結算效果，需要擴展 `processResolutionCard()` 方法。
