<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¸¬è©¦ï¼šè¡Œå‹•éšæ®µæŠ½ç‰ŒåŠŸèƒ½</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #1a1a2e;
      color: #eee;
    }
    h1 { color: #4ade80; }
    .instructions {
      background: #16213e;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #4ade80;
    }
    .step {
      margin: 10px 0;
      padding: 10px;
      background: #0f3460;
      border-radius: 4px;
    }
    button {
      background: #4ade80;
      color: #1a1a2e;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 6px;
      cursor: pointer;
      margin: 10px 10px 10px 0;
    }
    button:hover { background: #22c55e; }
    button:disabled {
      background: #666;
      cursor: not-allowed;
    }
    #result {
      margin-top: 20px;
      padding: 15px;
      background: #16213e;
      border-radius: 8px;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
    }
    .success { color: #4ade80; }
    .error { color: #ef4444; }
    .info { color: #60a5fa; }
  </style>
</head>
<body>
  <h1>ğŸƒ æ¸¬è©¦ï¼šè¡Œå‹•éšæ®µæŠ½ç‰ŒåŠŸèƒ½</h1>

  <div class="instructions">
    <h2>æ¸¬è©¦æ­¥é©Ÿï¼š</h2>
    <div class="step">1. æ‰“é–‹éŠæˆ²é é¢ï¼š<a href="http://localhost:5173/the-vale-of-eternity/" target="_blank" style="color: #60a5fa;">http://localhost:5173/the-vale-of-eternity/</a></div>
    <div class="step">2. é»æ“Šä¸‹æ–¹ã€Œé–‹å§‹è‡ªå‹•æ¸¬è©¦ã€æŒ‰éˆ•</div>
    <div class="step">3. æ¸¬è©¦å°‡è‡ªå‹•ï¼šåˆå§‹åŒ–éŠæˆ² â†’ é¸æ“‡ç¥å™¨ â†’ é¸æ“‡åˆå§‹å¡ç‰‡ â†’ é€²å…¥ ACTION éšæ®µ â†’ é»æ“ŠæŠ½ç‰ŒæŒ‰éˆ• â†’ é©—è­‰æ‰‹ç‰Œæ•¸é‡</div>
  </div>

  <button onclick="runTest()">ğŸš€ é–‹å§‹è‡ªå‹•æ¸¬è©¦</button>
  <button onclick="clearResult()">ğŸ—‘ï¸ æ¸…é™¤çµæœ</button>

  <div id="result"></div>

  <script>
    const resultDiv = document.getElementById('result');

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
      resultDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
      resultDiv.scrollTop = resultDiv.scrollHeight;
    }

    function clearResult() {
      resultDiv.innerHTML = '';
    }

    async function runTest() {
      clearResult();
      log('========================================', 'info');
      log('é–‹å§‹æ¸¬è©¦ï¼šè¡Œå‹•éšæ®µæŠ½ç‰ŒåŠŸèƒ½', 'info');
      log('========================================', 'info');

      try {
        // æª¢æŸ¥éŠæˆ²é é¢æ˜¯å¦é–‹å•Ÿ
        log('æª¢æŸ¥éŠæˆ²é é¢...', 'info');
        const gameWindow = window.open('', 'gameTab');

        if (!gameWindow || gameWindow.closed) {
          log('âŒ è«‹å…ˆæ‰“é–‹éŠæˆ²é é¢ï¼', 'error');
          log('é»æ“Šä¸Šæ–¹é€£çµæ‰“é–‹éŠæˆ²å¾Œå†é‡è©¦', 'error');
          return;
        }

        log('âœ“ éŠæˆ²é é¢å·²æ‰¾åˆ°', 'success');

        // æ³¨å…¥æ¸¬è©¦è…³æœ¬åˆ°éŠæˆ²é é¢
        const testScript = `
          (async function() {
            const utils = {
              sleep: (ms) => new Promise(r => setTimeout(r, ms)),
              click: async (selector) => {
                const el = document.querySelector(selector);
                if (!el) throw new Error('æ‰¾ä¸åˆ°å…ƒç´ : ' + selector);
                el.click();
                await utils.sleep(300);
              },
              count: (selector) => document.querySelectorAll(selector).length,
              getText: (selector) => {
                const el = document.querySelector(selector);
                return el ? el.textContent.trim() : '';
              },
              waitFor: async (selector, timeout = 5000) => {
                const start = Date.now();
                while (Date.now() - start < timeout) {
                  if (document.querySelector(selector)) return true;
                  await utils.sleep(100);
                }
                throw new Error('ç­‰å¾…è¶…æ™‚: ' + selector);
              }
            };

            try {
              // Step 1: é»æ“Šé–‹å§‹éŠæˆ²
              console.log('[TEST] Step 1: é»æ“Šé–‹å§‹éŠæˆ²');
              const startBtn = Array.from(document.querySelectorAll('button'))
                .find(btn => btn.textContent.includes('é–‹å§‹éŠæˆ²'));
              if (startBtn) {
                startBtn.click();
                await utils.sleep(1000);
              }

              // Step 2: é¸æ“‡ç¥å™¨
              console.log('[TEST] Step 2: é¸æ“‡ç¥å™¨');
              await utils.waitFor('[data-testid="artifact-card"]', 5000);
              const artifactCard = document.querySelector('[data-testid="artifact-card"]');
              if (artifactCard) {
                artifactCard.click();
                await utils.sleep(500);
              }

              const confirmArtifact = Array.from(document.querySelectorAll('button'))
                .find(btn => btn.textContent.includes('ç¢ºèª'));
              if (confirmArtifact) {
                confirmArtifact.click();
                await utils.sleep(1000);
              }

              // Step 3: é¸æ“‡åˆå§‹å¡ç‰‡
              console.log('[TEST] Step 3: é¸æ“‡åˆå§‹å¡ç‰‡');
              const marketCards = document.querySelectorAll('[data-testid="market-card"]');
              if (marketCards.length >= 2) {
                marketCards[0].click();
                await utils.sleep(200);
                marketCards[1].click();
                await utils.sleep(500);
              }

              const confirmCards = Array.from(document.querySelectorAll('button'))
                .find(btn => btn.textContent.includes('ç¢ºèª'));
              if (confirmCards) {
                confirmCards.click();
                await utils.sleep(1500);
              }

              // Step 4: ç¢ºèªé€²å…¥ ACTION éšæ®µ
              console.log('[TEST] Step 4: ç¢ºèª ACTION éšæ®µ');
              const phase = utils.getText('[class*="phase"], [class*="Phase"]');
              if (!phase.includes('è¡Œå‹•') && !phase.includes('ACTION')) {
                throw new Error('æœªé€²å…¥ ACTION éšæ®µ: ' + phase);
              }

              // Step 5: è¨˜éŒ„æ‰‹ç‰Œæ•¸é‡
              console.log('[TEST] Step 5: è¨˜éŒ„æ‰‹ç‰Œæ•¸é‡');
              const handCountBefore = utils.count('[class*="hand"] .card, [class*="Hand"] .card');
              console.log('[TEST] æ‰‹ç‰Œæ•¸é‡ï¼ˆæŠ½ç‰Œå‰ï¼‰:', handCountBefore);

              // Step 6: æŸ¥æ‰¾ä¸¦é»æ“ŠæŠ½ç‰ŒæŒ‰éˆ•
              console.log('[TEST] Step 6: æŸ¥æ‰¾æŠ½ç‰ŒæŒ‰éˆ•');
              const drawBtn = Array.from(document.querySelectorAll('button'))
                .find(btn => btn.textContent.includes('æŠ½ç‰Œ') || btn.textContent.includes('ğŸƒ'));

              if (!drawBtn) {
                throw new Error('âŒ æ‰¾ä¸åˆ°æŠ½ç‰ŒæŒ‰éˆ•ï¼');
              }

              if (drawBtn.disabled) {
                throw new Error('âŒ æŠ½ç‰ŒæŒ‰éˆ•è¢«ç¦ç”¨ï¼');
              }

              console.log('[TEST] âœ“ æ‰¾åˆ°æŠ½ç‰ŒæŒ‰éˆ•ï¼Œæº–å‚™é»æ“Š');
              drawBtn.click();
              await utils.sleep(1500);

              // Step 7: æª¢æŸ¥æ‰‹ç‰Œæ•¸é‡
              console.log('[TEST] Step 7: æª¢æŸ¥æ‰‹ç‰Œæ•¸é‡');
              const handCountAfter = utils.count('[class*="hand"] .card, [class*="Hand"] .card');
              console.log('[TEST] æ‰‹ç‰Œæ•¸é‡ï¼ˆæŠ½ç‰Œå¾Œï¼‰:', handCountAfter);

              if (handCountAfter !== handCountBefore + 1) {
                throw new Error(\`æ‰‹ç‰Œæ•¸é‡éŒ¯èª¤ï¼æœŸæœ›: \${handCountBefore + 1}, å¯¦éš›: \${handCountAfter}\`);
              }

              // Step 8: ç¢ºèªä»åœ¨ ACTION éšæ®µ
              console.log('[TEST] Step 8: ç¢ºèªä»åœ¨ ACTION éšæ®µ');
              const phaseAfter = utils.getText('[class*="phase"], [class*="Phase"]');
              if (!phaseAfter.includes('è¡Œå‹•') && !phaseAfter.includes('ACTION')) {
                throw new Error('éšæ®µéŒ¯èª¤: ' + phaseAfter);
              }

              return {
                success: true,
                handBefore: handCountBefore,
                handAfter: handCountAfter,
                message: 'TEST PASSED âœ“'
              };

            } catch (error) {
              return {
                success: false,
                error: error.message
              };
            }
          })();
        `;

        log('æ­£åœ¨éŠæˆ²é é¢åŸ·è¡Œæ¸¬è©¦...', 'info');

        const result = await gameWindow.eval(testScript);

        if (result.success) {
          log('========================================', 'success');
          log('âœ… æ¸¬è©¦é€šéï¼', 'success');
          log(`æ‰‹ç‰Œæ•¸é‡è®ŠåŒ–: ${result.handBefore} â†’ ${result.handAfter}`, 'success');
          log('æŠ½ç‰ŒåŠŸèƒ½æ­£å¸¸é‹ä½œï¼', 'success');
          log('========================================', 'success');
        } else {
          log('========================================', 'error');
          log('âŒ æ¸¬è©¦å¤±æ•—ï¼', 'error');
          log('éŒ¯èª¤: ' + result.error, 'error');
          log('========================================', 'error');
        }

      } catch (error) {
        log('========================================', 'error');
        log('âŒ æ¸¬è©¦åŸ·è¡ŒéŒ¯èª¤: ' + error.message, 'error');
        log('è«‹ç¢ºä¿ï¼š', 'error');
        log('1. éŠæˆ²é é¢å·²åœ¨æ–°åˆ†é é–‹å•Ÿ', 'error');
        log('2. éŠæˆ²æ­£å¸¸è¼‰å…¥', 'error');
        log('3. æ²’æœ‰ Console éŒ¯èª¤', 'error');
        log('========================================', 'error');
      }
    }

    log('æ¸¬è©¦è…³æœ¬å·²è¼‰å…¥ï¼Œè«‹æŒ‰ã€Œé–‹å§‹è‡ªå‹•æ¸¬è©¦ã€æŒ‰éˆ•', 'info');
  </script>
</body>
</html>
